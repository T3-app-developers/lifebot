<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Lifebot Town</title>
  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #renderCanvas { width: 100%; height: 100%; }
  </style>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
</head>
<body>
  <canvas id="renderCanvas"></canvas>
  <script>
    const canvas = document.getElementById('renderCanvas');
    const engine = new BABYLON.Engine(canvas, true);

    function buildHouse(name, x, scene) {
      const house = new BABYLON.TransformNode(name, scene);
      const size = 4;
      const height = 3;
      const t = 0.1;
      const doorWidth = 1.5;
      const doorHeight = 2.2;

      const floor = BABYLON.MeshBuilder.CreateBox(name+'Floor', {width:size, depth:size, height:t}, scene);
      floor.position.y = t/2;
      floor.parent = house;

      const roof = BABYLON.MeshBuilder.CreateBox(name+'Roof', {width:size, depth:size, height:t}, scene);
      roof.position.y = height + t/2;
      roof.parent = house;

      const back = BABYLON.MeshBuilder.CreateBox(name+'Back', {width:size, height:height, depth:t}, scene);
      back.position.set(0, height/2, -size/2 + t/2);
      back.parent = house;

      const left = BABYLON.MeshBuilder.CreateBox(name+'Left', {width:t, height:height, depth:size}, scene);
      left.position.set(-size/2 + t/2, height/2, 0);
      left.parent = house;

      const right = BABYLON.MeshBuilder.CreateBox(name+'Right', {width:t, height:height, depth:size}, scene);
      right.position.set(size/2 - t/2, height/2, 0);
      right.parent = house;

      const sideWidth = (size - doorWidth)/2;
      const frontLeft = BABYLON.MeshBuilder.CreateBox(name+'FrontLeft', {width:sideWidth, height:height, depth:t}, scene);
      frontLeft.position.set(-doorWidth/2 - sideWidth/2, height/2, size/2 - t/2);
      frontLeft.parent = house;

      const frontRight = BABYLON.MeshBuilder.CreateBox(name+'FrontRight', {width:sideWidth, height:height, depth:t}, scene);
      frontRight.position.set(doorWidth/2 + sideWidth/2, height/2, size/2 - t/2);
      frontRight.parent = house;

      const topH = height - doorHeight;
      const frontTop = BABYLON.MeshBuilder.CreateBox(name+'FrontTop', {width:doorWidth, height:topH, depth:t}, scene);
      frontTop.position.set(0, doorHeight + topH/2, size/2 - t/2);
      frontTop.parent = house;

      const bed = BABYLON.MeshBuilder.CreateBox(name+'Bed', {width:1.5, height:0.5, depth:2}, scene);
      bed.position.set(-1.2, 0.25, -0.8);
      bed.parent = house;

      const sink = BABYLON.MeshBuilder.CreateBox(name+'Sink', {width:1, height:0.6, depth:0.5}, scene);
      sink.position.set(1.2, 0.3, -1.5);
      sink.isPickable = true;
      sink.parent = house;

      const faucet = BABYLON.MeshBuilder.CreateBox(name+'Faucet', {width:0.1, height:0.1, depth:0.4}, scene);
      faucet.position.set(0, 0.35, -0.25);
      faucet.parent = sink;

      const anim = new BABYLON.Animation(name+'Tap', 'rotation.z', 30, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);
      anim.setKeys([
        {frame:0, value:0},
        {frame:15, value:Math.PI/2},
        {frame:30, value:0}
      ]);
      faucet.animations = [anim];
      sink.actionManager = new BABYLON.ActionManager(scene);
      sink.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger, function(){
        scene.beginAnimation(faucet, 0, 30, false);
      }));

      house.position.x = x;
    }

    const createScene = function() {
      const scene = new BABYLON.Scene(engine);

      const camera = new BABYLON.UniversalCamera('player', new BABYLON.Vector3(0, 1.7, -10), scene);
      camera.attachControl(canvas, true);
      camera.speed = 0.25;

      scene.onPointerDown = function(){
        if(!document.pointerLockElement){
          canvas.requestPointerLock();
        }
      };

      new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);
      BABYLON.MeshBuilder.CreateGround('ground', {width:40, height:20}, scene);

      buildHouse('house1', -6, scene);
      buildHouse('house2', 0, scene);
      buildHouse('house3', 6, scene);

      return scene;
    };

    const scene = createScene();

    engine.runRenderLoop(function () {
      scene.render();
    });

    window.addEventListener('resize', function () {
      engine.resize();
    });
  </script>
</body>
</html>
